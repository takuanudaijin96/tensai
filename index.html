<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>æ­´å²åœ°å›³ã‚¯ã‚¤ã‚ºï¼ˆç”»åƒå²æ–™ç‰ˆï¼‰</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
  margin: 0;
  font-family: system-ui, sans-serif;
  background: #f2f2f2;
}
.hidden { display: none; }
.screen { padding: 12px; max-width: 720px; margin: auto; }

button {
  width: 100%;
  padding: 12px;
  margin: 6px 0;
  font-size: 16px;
  border: none;
  border-radius: 10px;
  background: #4a90e2;
  color: white;
}
.secondary { background: #777; }
.danger { background: #e74c3c; }
.choice { background: #2ecc71; }

input, select, textarea {
  width: 100%;
  padding: 8px;
  margin: 6px 0;
  font-size: 16px;
}

#imageArea { position: relative; }
img { width: 100%; display: block; }

.pin {
  position: absolute;
  width: 10px;
  height: 10px;
  background: red;
  border-radius: 50%;
  transform: translate(-50%, -50%);
  pointer-events: none;
}

.card {
  background: white;
  border-radius: 10px;
  padding: 10px;
  margin: 8px 0;
}
.correct { color: green; }
.wrong { color: red; }
</style>
</head>

<body>

<!-- ãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
<div class="screen" id="menu">
  <h2>æ­´å²åœ°å›³ã‚¯ã‚¤ã‚º</h2>
  <button onclick="openPlayChapterSelect()">â–¶ è§£ç­”ãƒ¢ãƒ¼ãƒ‰</button>
  <button class="secondary" onclick="show('chapterManage')">âš™ ä½œå•ãƒ¢ãƒ¼ãƒ‰</button>
</div>

<!-- è§£ç­”ï¼šç« é¸æŠ -->
<div class="screen hidden" id="playChapterSelect">
  <h3>ç« ã‚’é¸æŠ</h3>
  <select id="playChapterSelectBox"></select>

  <select id="difficultyFilter">
    <option value="all">ã™ã¹ã¦ã®é›£æ˜“åº¦</option>
    <option value="1">â˜… ã‹ã‚“ãŸã‚“</option>
    <option value="2">â˜…â˜… ãµã¤ã†</option>
    <option value="3">â˜…â˜…â˜… ã‚€ãšã‹ã—ã„</option>
  </select>

  <button onclick="startQuizFromSelect()">é–‹å§‹</button>
  <button class="secondary" onclick="show('menu')">æˆ»ã‚‹</button>
</div>

<!-- ä½œå•ï¼šç« ç®¡ç† -->
<div class="screen hidden" id="chapterManage">
  <h3>ç« ã®ç®¡ç†</h3>

  <input id="newChapterName" placeholder="æ–°ã—ã„ç« å">
  <input type="file" accept="image/*" onchange="loadChapterImage(event)">
  <select id="answerType">
    <option value="choice">é¸æŠå¼</option>
    <option value="input">å…¥åŠ›å¼</option>
  </select>
  <button onclick="createChapter()">ç« ã‚’ä½œæˆ</button>

  <hr>

  <select id="chapterSelectCreate"></select>
  <button onclick="openQuestionCreate()">ã“ã®ç« ã§ä½œå•</button>

  <button class="secondary" onclick="show('menu')">æˆ»ã‚‹</button>
</div>

<!-- ä½œå• -->
<div class="screen hidden" id="questionCreate">
  <h3 id="createTitle"></h3>

  <div id="imageArea">
    <img id="createImage">
    <div class="pin hidden" id="createPin"></div>
  </div>

  <select id="difficultySelect">
    <option value="1">â˜… ã‹ã‚“ãŸã‚“</option>
    <option value="2">â˜…â˜… ãµã¤ã†</option>
    <option value="3">â˜…â˜…â˜… ã‚€ãšã‹ã—ã„</option>
  </select>

  <input id="answerInput" placeholder="æ­£è§£">
  <input id="c1" placeholder="é¸æŠè‚¢1">
  <input id="c2" placeholder="é¸æŠè‚¢2">
  <input id="c3" placeholder="é¸æŠè‚¢3">
  <input id="h1" placeholder="ãƒ’ãƒ³ãƒˆâ‘ ">
  <input id="h2" placeholder="ãƒ’ãƒ³ãƒˆâ‘¡">

  <button onclick="saveQuestion()">ä¿å­˜</button>
  <button onclick="openQuestionList()">ğŸ“‹ å•é¡Œä¸€è¦§</button>
  <button class="secondary" onclick="show('chapterManage')">æˆ»ã‚‹</button>
</div>

<!-- å•é¡Œä¸€è¦§ -->
<div class="screen hidden" id="questionList">
  <h3 id="listTitle"></h3>
  <div id="list"></div>
  <button onclick="openQuestionCreate()">ï¼‹ ä½œå•ã«æˆ»ã‚‹</button>
  <button class="secondary" onclick="show('chapterManage')">æˆ»ã‚‹</button>
</div>

<!-- ã‚¯ã‚¤ã‚º -->
<div class="screen hidden" id="quiz">
  <h3 id="quizTitle"></h3>
  <div id="imageArea">
    <img id="quizImage">
    <div class="pin" id="quizPin"></div>
  </div>
  <div class="card">ã“ã®åœ°ç‚¹ã¯ï¼Ÿ</div>
  <div id="answerArea"></div>
  <button onclick="showHint()">ãƒ’ãƒ³ãƒˆ</button>
  <div id="hintArea"></div>
</div>

<!-- çµæœ -->
<div class="screen hidden" id="result">
  <h3>çµæœ</h3>
  <div class="card" id="summary"></div>
  <ul id="detail"></ul>
  <button onclick="show('menu')">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¸</button>
</div>

<script>
let data = JSON.parse(localStorage.getItem("historyData") || "{}");
let currentChapter="", tempPos=null, quizIndex=0, results=[];
let tempImage=null, hintStep=0;
let quizQuestions=[];

function save(){ localStorage.setItem("historyData", JSON.stringify(data)); }
function show(id){
  document.querySelectorAll(".screen").forEach(s=>s.classList.add("hidden"));
  document.getElementById(id).classList.remove("hidden");
}

/* ---------- è§£ç­”ãƒ¢ãƒ¼ãƒ‰ ---------- */

function openPlayChapterSelect(){
  const box=document.getElementById("playChapterSelectBox");
  box.innerHTML="";
  Object.keys(data).forEach(c=>{
    const o=document.createElement("option");
    o.value=o.textContent=c;
    box.appendChild(o);
  });
  if(box.options.length===0){ alert("ç« ãŒã¾ã ã‚ã‚Šã¾ã›ã‚“"); return; }
  show("playChapterSelect");
}

function startQuizFromSelect(){
  const ch = playChapterSelectBox.value;
  const diff = difficultyFilter.value;

  let qs = data[ch].questions;
  if(diff!=="all") qs = qs.filter(q=>q.difficulty==diff);
  if(qs.length===0){ alert("è©²å½“ã™ã‚‹å•é¡ŒãŒã‚ã‚Šã¾ã›ã‚“"); return; }

  quizQuestions = qs;
  currentChapter = ch;
  quizIndex = 0;
  results = [];
  showQuiz();
}

function showQuiz(){
  const q = quizQuestions[quizIndex];
  quizTitle.textContent = `ç« ï¼š${currentChapter}ï¼ˆâ˜…${q.difficulty}ï¼‰`;
  quizImage.src = data[currentChapter].image;
  quizPin.style.left=q.x*100+"%";
  quizPin.style.top=q.y*100+"%";

  answerArea.innerHTML="";
  hintArea.textContent="";
  hintStep=0;

  if(data[currentChapter].type==="choice"){
    q.choices.forEach(c=>{
      const b=document.createElement("button");
      b.className="choice";
      b.textContent=c;
      b.onclick=()=>judge(c);
      answerArea.appendChild(b);
    });
  }else{
    const i=document.createElement("input");
    const b=document.createElement("button");
    b.textContent="æ±ºå®š";
    b.onclick=()=>judge(i.value);
    answerArea.append(i,b);
  }
  show("quiz");
}

function judge(sel){
  const q = quizQuestions[quizIndex];
  results.push({a:q.answer,s:sel,c:sel===q.answer});
  quizIndex++;
  quizIndex<quizQuestions.length?showQuiz():showResult();
}

function showHint(){
  const h=quizQuestions[quizIndex].hints;
  if(h[hintStep]) hintArea.textContent+=h[hintStep++]+"\n";
}

function showResult(){
  const c=results.filter(r=>r.c).length;
  summary.textContent=`æ­£è§£ ${c}/${results.length}`;
  detail.innerHTML="";
  results.forEach(r=>{
    const li=document.createElement("li");
    li.textContent=r.a+(r.c?"":"ï¼ˆÃ— "+r.s+"ï¼‰");
    li.className=r.c?"correct":"wrong";
    detail.appendChild(li);
  });
  show("result");
}

/* ---------- ä½œå•ãƒ¢ãƒ¼ãƒ‰ ---------- */

function resizeImage(file, cb){
  const img=new Image();
  img.onload=()=>{
    const max=1200, scale=Math.min(1,max/img.width);
    const c=document.createElement("canvas");
    c.width=img.width*scale;
    c.height=img.height*scale;
    c.getContext("2d").drawImage(img,0,0,c.width,c.height);
    cb(c.toDataURL("image/jpeg",0.9));
  };
  img.src=URL.createObjectURL(file);
}

function loadChapterImage(e){
  resizeImage(e.target.files[0], d=>tempImage=d);
}

function createChapter(){
  if(!newChapterName.value||!tempImage)return alert("ç« åã¨ç”»åƒå¿…é ˆ");
  data[newChapterName.value]={image:tempImage,questions:[],type:answerType.value};
  save(); updateChapterSelects();
  newChapterName.value=""; tempImage=null;
}

function updateChapterSelects(){
  chapterSelectCreate.innerHTML="";
  Object.keys(data).forEach(c=>{
    const o=document.createElement("option");
    o.value=o.textContent=c;
    chapterSelectCreate.appendChild(o);
  });
}
updateChapterSelects();

function openQuestionCreate(){
  currentChapter=chapterSelectCreate.value;
  createTitle.textContent="ç« ï¼š"+currentChapter;
  createImage.src=data[currentChapter].image;
  show("questionCreate");
}

createImage.onclick=e=>{
  const r=e.target.getBoundingClientRect();
  tempPos={x:(e.clientX-r.left)/r.width,y:(e.clientY-r.top)/r.height};
  createPin.style.left=tempPos.x*100+"%";
  createPin.style.top=tempPos.y*100+"%";
  createPin.classList.remove("hidden");
};

function saveQuestion(){
  if(!tempPos)return alert("åœ°ç‚¹æœªæŒ‡å®š");
  data[currentChapter].questions.push({
    ...tempPos,
    answer:answerInput.value,
    choices:[c1.value,c2.value,c3.value],
    hints:[h1.value,h2.value],
    difficulty:Number(difficultySelect.value)
  });
  save();
  answerInput.value=c1.value=c2.value=c3.value=h1.value=h2.value="";
  createPin.classList.add("hidden");
  tempPos=null;
}

function openQuestionList(){
  listTitle.textContent="ç« ï¼š"+currentChapter;
  list.innerHTML="";
  data[currentChapter].questions.forEach((q,i)=>{
    const d=document.createElement("div");
    d.className="card";
    d.textContent=`${i+1}. â˜…${q.difficulty} ${q.answer}`;
    const b=document.createElement("button");
    b.textContent="å‰Šé™¤";
    b.className="danger";
    b.onclick=()=>{if(confirm("å‰Šé™¤ï¼Ÿ")){data[currentChapter].questions.splice(i,1);save();openQuestionList();}};
    d.appendChild(b);
    list.appendChild(d);
  });
  show("questionList");
}
</script>
</body>
</html>
